{"version":3,"file":"busy.directive.js","sourceRoot":"","sources":["../src/busy.directive.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * @file Directive: Bus\r\n * @author yumao<yuzhang.lille@gmail.com>\r\n */\r\n\r\nimport {\r\n    Directive,\r\n    Component,\r\n    Input,\r\n    DoCheck,\r\n    ViewContainerRef,\r\n    ComponentFactoryResolver,\r\n    ComponentRef,\r\n    Injector\r\n} from '@angular/core';\r\nimport {Subscription} from 'rxjs/Subscription';\r\n\r\nimport {equals} from './util';\r\nimport {PromiseTrackerService} from './promise-tracker.service';\r\nimport {BusyService} from './busy.service';\r\nimport {IBusyConfig} from './busy-config';\r\nimport {BusyComponent} from './busy.component';\r\nimport {BusyBackdropComponent} from './busy-backdrop.component';\r\n\r\n/**\r\n * ### Syntax\r\n *\r\n * - `<div [ngBusy]=\"busy\">...</div>`\r\n * - `<div [ngBusy]=\"[busyA, busyB, busyC]\">...</div>`\r\n * - `<div [ngBusy]=\"{busy: busy, message: 'Loading...', backdrop: false, delay: 200, minDuration: 600}\">...</div>`\r\n */\r\n\r\nexport class BusyDirective implements DoCheck {\r\n     options: any;\r\n    private optionsRecord: any;\r\n    private optionsNorm: IBusyConfig;\r\n    template: string;\r\n    backdrop: boolean;\r\n    private busyRef: ComponentRef<BusyComponent>;\r\n    private backdropRef: ComponentRef<BusyBackdropComponent>;\r\n\r\n    constructor(\r\n        private service: BusyService,\r\n        private tracker: PromiseTrackerService,\r\n        private cfResolver: ComponentFactoryResolver,\r\n        private vcRef: ViewContainerRef,\r\n        private injector: Injector\r\n    ) {\r\n    }\r\n\r\n    private normalizeOptions(options: any) {\r\n        if (!options) {\r\n            options = {busy: null};\r\n        }\r\n        else if (Array.isArray(options)\r\n            || options instanceof Promise\r\n            || options instanceof Subscription\r\n        ) {\r\n            options = {busy: options};\r\n        }\r\n        options = Object.assign({}, this.service.config, options);\r\n        if (!Array.isArray(options.busy)) {\r\n            options.busy = [options.busy];\r\n        }\r\n\r\n        return options;\r\n    }\r\n\r\n    private dectectOptionsChange() {\r\n        if (equals(this.optionsNorm, this.optionsRecord)) {\r\n            return false;\r\n        }\r\n        this.optionsRecord = this.optionsNorm;\r\n        return true;\r\n    }\r\n\r\n    // As ngOnChanges does not work on Object detection, ngDoCheck is using\r\n    ngDoCheck() {\r\n        let options = this.optionsNorm = this.normalizeOptions(this.options);\r\n\r\n        if (!this.dectectOptionsChange()) {\r\n            return;\r\n        }\r\n\r\n        if (this.busyRef) {\r\n            this.busyRef.instance.context.message = options.message;\r\n        }\r\n\r\n        !equals(options.busy, this.tracker.promiseList)\r\n            && this.tracker.reset({\r\n                promiseList: options.busy,\r\n                delay: options.delay,\r\n                minDuration: options.minDuration\r\n            });\r\n\r\n        if (!this.busyRef\r\n            || this.template !== options.template\r\n            || this.backdrop !== options.backdrop\r\n        ) {\r\n            this.destroyComponents();\r\n\r\n            this.template = options.template;\r\n            this.backdrop = options.backdrop;\r\n\r\n            options.backdrop && this.createBackdrop();\r\n\r\n            this.createBusy();\r\n        }\r\n    }\r\n\r\n    ngOnDestroy() {\r\n        this.destroyComponents();\r\n    }\r\n\r\n    private destroyComponents() {\r\n        this.busyRef && this.busyRef.destroy();\r\n        this.backdropRef && this.backdropRef.destroy();\r\n    }\r\n\r\n    private createBackdrop() {\r\n        const backdropFactory = this.cfResolver.resolveComponentFactory(BusyBackdropComponent);\r\n        this.backdropRef = this.vcRef.createComponent(backdropFactory, undefined, this.injector);\r\n    }\r\n\r\n    private createBusy() {\r\n        const busyFactory = this.cfResolver.resolveComponentFactory(BusyComponent);\r\n        this.busyRef = this.vcRef.createComponent(busyFactory, undefined, this.injector);\r\n\r\n        const {message, wrapperClass, template} = this.optionsNorm;\r\n        let instance = this.busyRef.instance;\r\n        (<any>instance)['context']['message'] = message;\r\n        (<any>instance)['wrapperClass'] = wrapperClass;\r\n        (<any>instance)['template'] = template;\r\n    }\r\nstatic decorators: DecoratorInvocation[] = [\n{ type: Directive, args: [{\r\n    selector: '[ngBusy]',\r\n    providers: [PromiseTrackerService]\r\n}, ] },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n{type: BusyService, },\n{type: PromiseTrackerService, },\n{type: ComponentFactoryResolver, },\n{type: ViewContainerRef, },\n{type: Injector, },\n];\nstatic propDecorators: {[key: string]: DecoratorInvocation[]} = {\n'options': [{ type: Input, args: ['ngBusy', ] },],\n};\n}\r\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}