{"version":3,"file":"promise-tracker.service.js","sourceRoot":"","sources":["../src/promise-tracker.service.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * @file Service: PromiseTracker\r\n * @author yumao<yuzhang.lille@gmail.com>\r\n */\r\n\r\n// Inspired by angular-promise-tracker\r\n// Add Observable Subscription\r\n\r\nimport {Injectable} from '@angular/core';\r\nimport {Subscription} from 'rxjs/Subscription';\r\n\r\n\r\nexport class PromiseTrackerService {\r\n    promiseList: Array<Promise<any> | Subscription> = [];\r\n    delayPromise: number | any;\r\n    durationPromise: number | any;\r\n    delayJustFinished: boolean = false;\r\n    minDuration: number;\r\n\r\n    reset(options: IPromiseTrackerOptions) {\r\n        this.minDuration = options.minDuration;\r\n\r\n        this.promiseList = [];\r\n        options.promiseList.forEach(promise => {\r\n            if (!promise || (<any>promise)['busyFulfilled']) {\r\n                return;\r\n            }\r\n            this.addPromise(promise);\r\n        });\r\n\r\n        if (this.promiseList.length === 0) {\r\n            return;\r\n        }\r\n\r\n        this.delayJustFinished = false;\r\n        if (options.delay) {\r\n            this.delayPromise = setTimeout(\r\n                () => {\r\n                    this.delayPromise = null;\r\n                    this.delayJustFinished = true;\r\n                },\r\n                options.delay\r\n            );\r\n        }\r\n        if (options.minDuration) {\r\n            this.durationPromise = setTimeout(\r\n                () => {\r\n                    this.durationPromise = null;\r\n                },\r\n                options.minDuration + (options.delay || 0)\r\n            );\r\n        }\r\n    }\r\n\r\n    private addPromise(promise: Promise<any> | Subscription) {\r\n        if (this.promiseList.indexOf(promise) !== -1) {\r\n            return;\r\n        }\r\n\r\n        this.promiseList.push(promise);\r\n\r\n        if (promise instanceof Promise) {\r\n            promise.then.call(\r\n                promise,\r\n                () => this.finishPromise(promise),\r\n                () => this.finishPromise(promise)\r\n            );\r\n        }\r\n        else if (promise instanceof Subscription) {\r\n            promise.add(() => this.finishPromise(promise));\r\n        }\r\n    }\r\n\r\n    private finishPromise(promise: Promise<any> | Subscription) {\r\n        (<any>promise)['busyFulfilled'] = true;\r\n        const index = this.promiseList.indexOf(promise);\r\n        if (index === -1) {\r\n            return;\r\n        }\r\n        this.promiseList.splice(index, 1);\r\n    }\r\n\r\n    isActive() {\r\n        if (this.delayPromise) {\r\n            return false;\r\n        }\r\n\r\n        if (!this.delayJustFinished) {\r\n            if (this.durationPromise) {\r\n                return true;\r\n            }\r\n            return this.promiseList.length > 0;\r\n        }\r\n\r\n        this.delayJustFinished = false;\r\n        if (this.promiseList.length === 0) {\r\n            this.durationPromise = null;\r\n        }\r\n        return this.promiseList.length > 0;\r\n    }\r\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: () => ({type: any, decorators?: DecoratorInvocation[]}|null)[] = () => [\n];\n}\r\n\r\nexport interface IPromiseTrackerOptions {\r\n    minDuration: number;\r\n    delay: number;\r\n    promiseList: Promise<any>[];\r\n}\r\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}